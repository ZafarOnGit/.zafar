<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEAM College Predictor 2025</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: { extend: { fontFamily: { inter: ['Inter', 'sans-serif'] } } }
      }
    </script>
    <style>
        html, body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        /* Custom Scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Loading Indicator Styling */
        .loading-indicator {
            display: none;
            text-align: center;
            margin-top: 20px;
            color: #4A5568;
        }

        /* Dropdown Specific Styling (for both branch and college) */
        .custom-dropdown {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .custom-dropdown-button {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            background-color: white;
            text-align: left;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            color: #4B5563;
            font-size: 0.875rem;
        }

        .custom-dropdown-button:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.5);
            border-color: transparent;
        }

        .custom-dropdown-content {
            display: none;
            position: absolute;
            background: #f9f9f9;
            min-width: 100%;
            max-height: 250px;
            overflow-y: auto;
            z-index: 10;
            border-radius: 0.5rem;
            border: 1.5px solid #E5E7EB;
            margin-top: 5px;
            box-shadow: 0 4px 24px 0 rgba(0,0,0,0.10);
            transition: opacity 0.2s, transform 0.2s;
            opacity: 0;
            transform: scaleY(0.97);
            transform-origin: top;
        }

        .custom-dropdown-content.show {
            display: block;
            opacity: 1;
            transform: scaleY(1);
        }

        .custom-dropdown-item {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background 0.15s;
            border-radius: 0.375rem;
        }

        .custom-dropdown-item:hover {
            background: #e0e7ff;
        }

        .custom-dropdown-item input[type="checkbox"] {
            margin-right: 8px;
            height: 1.25rem;
            width: 1.25rem;
            border-radius: 0.25rem;
            border-color: #D1D5DB;
            color: #2563EB;
            transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out;
            cursor: pointer;
        }

        .custom-dropdown-item label {
            cursor: pointer;
            flex-grow: 1;
        }

        .search-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: 1.5px solid #E5E7EB;
            border-radius: 0.25rem;
            font-size: 0.95rem;
            transition: border 0.2s, box-shadow 0.2s;
        }

        .search-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px #c7d2fe;
        }

        input[type="checkbox"] {
            accent-color: #2563eb;
            transition: transform 0.15s;
        }

        input[type="checkbox"]:active {
            transform: scale(1.15);
        }

        /* Dark mode overrides */
        html.dark body { background: linear-gradient(135deg, #181f2a 0%, #232946 100%) !important; }
        html.dark .custom-dropdown-content { background: #232946; border-color: #334155; color: #e0e7ef; }
        html.dark .custom-dropdown-item:hover { background: #334155; }
        html.dark .search-input { background: #232946; color: #e0e7ef; border-color: #334155; }
        html.dark .search-input:focus { border-color: #6366f1; box-shadow: 0 0 0 2px #6366f1; }
        /* Dual-icon sun/moon toggle animation */
        #sunIcon, #moonIcon {
            pointer-events: none;
        }
        .dark #sunIcon {
            opacity: 0 !important;
            scale: 0.75;
            transform: rotate(-45deg);
        }
        .dark #moonIcon {
            opacity: 1 !important;
            scale: 1;
            transform: rotate(0deg);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-200 via-indigo-100 to-purple-200 dark:from-[#181f2a] dark:via-[#232946] dark:to-[#181f2a] min-h-screen flex items-center justify-center p-4 font-inter transition-colors duration-300">
    <div class="relative w-full max-w-sm sm:max-w-md md:max-w-xl lg:max-w-2xl">
        <!-- Dark/Light Mode Toggle -->
        <div class="absolute top-4 right-4 z-20 flex items-center">
          <button
            id="themeToggle"
            class="theme-toggle bg-white/80 dark:bg-[#232946] border border-blue-200 dark:border-[#334155] rounded-full shadow p-1 transition-colors duration-300 flex items-center justify-center"
            type="button"
            title="Toggle theme"
            aria-label="Toggle theme"
            style="width:2.5rem;height:2.5rem;"
          >
            <span class="relative w-7 h-7 flex items-center justify-center">
              <!-- Sun Icon -->
              <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" class="absolute inset-0 w-7 h-7 transition-all duration-300 text-yellow-400 opacity-100 scale-100 rotate-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="5" fill="#facc15"/>
                <path stroke="#facc15" stroke-linecap="round" stroke-linejoin="round" d="M12 2v2m0 16v2m10-10h-2M4 12H2m16.95 7.07l-1.41-1.41M6.34 6.34L4.93 4.93m12.02 0l-1.41 1.41M6.34 17.66l-1.41 1.41"/>
              </svg>
              <!-- Moon Icon -->
              <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" class="absolute inset-0 w-7 h-7 transition-all duration-300 text-indigo-300 opacity-0 scale-75 rotate-45" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path fill="#a5b4fc" stroke="#a5b4fc" stroke-linecap="round" stroke-linejoin="round" d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 1 0 9.79 9.79z"/>
              </svg>
            </span>
          </button>
        </div>
        <div class="bg-white/80 dark:bg-[#232946]/90 backdrop-blur-md p-6 sm:p-8 rounded-2xl shadow-2xl w-full transition-all duration-300 hover:scale-[1.01] border border-blue-100 dark:border-[#334155]">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-center mb-6 tracking-tight font-inter" style="background: linear-gradient(90deg, #2563eb 0%, #7c3aed 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; line-height: 1.1;">KEAM College Predictor 2025</h1>
            <p class="text-gray-600 dark:text-blue-100/80 text-center text-base sm:text-lg mb-8 font-medium font-inter">Enter your predicted KEAM rank and select your category to find eligible colleges and courses based on 2024 cutoffs.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6 mb-8">
                <div>
                    <label for="predictedRank" class="block text-gray-700 dark:text-blue-100 text-sm font-semibold mb-2">Predicted Rank:</label>
                    <input type="number" id="predictedRank" placeholder="e.g., 1500" class="w-full px-4 py-2 border border-gray-300 dark:border-[#334155] rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition duration-200 text-sm sm:text-base bg-white/90 dark:bg-[#181f2a] dark:text-blue-100 shadow-sm font-inter">
                </div>
                <div>
                    <label for="studentCategory" class="block text-gray-700 dark:text-blue-100 text-sm font-semibold mb-2">Student Category:</label>
                    <select id="studentCategory" class="w-full px-4 py-2 border border-gray-300 dark:border-[#334155] rounded-lg bg-white/90 dark:bg-[#181f2a] dark:text-blue-100 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition duration-200 text-sm sm:text-base shadow-sm font-inter">
                        <option value="">Select Category</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-gray-700 dark:text-blue-100 text-sm font-semibold mb-2">Preferred Branches:</label>
                    <div class="relative" id="branchDropdown">
                        <button type="button" class="custom-dropdown-button w-full px-3 py-2 border border-gray-300 dark:border-[#334155] rounded-lg bg-white/90 dark:bg-[#181f2a] dark:text-blue-100 flex justify-between items-center text-sm transition duration-200 hover:shadow-md focus:ring-2 focus:ring-blue-300 font-inter" id="branchDropdownButton">
                            <span>Select Branches (Leave unchecked for no specific preference)</span>
                            <svg class="w-4 h-4 ml-2 text-gray-500 dark:text-blue-200 transition-transform duration-200 group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="custom-dropdown-content left-0 right-0 ring-1 ring-blue-200 dark:ring-[#334155] font-inter" id="branchDropdownContent">
                            <input type="text" class="search-input" placeholder="Search branches...">
                            <div class="p-2 text-gray-500 dark:text-blue-200">Loading Branches...</div>
                        </div>
                    </div>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-gray-700 dark:text-blue-100 text-sm font-semibold mb-2">Filter Colleges:</label>
                    <div class="relative" id="collegeFilterDropdown">
                        <button type="button" class="custom-dropdown-button w-full px-3 py-2 border border-gray-300 dark:border-[#334155] rounded-lg bg-white/90 dark:bg-[#181f2a] dark:text-blue-100 flex justify-between items-center text-sm transition duration-200 hover:shadow-md focus:ring-2 focus:ring-blue-300 font-inter" id="collegeFilterButton">
                            <span>Select Colleges (Leave unchecked for all colleges)</span>
                            <svg class="w-4 h-4 ml-2 text-gray-500 dark:text-blue-200 transition-transform duration-200 group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="custom-dropdown-content left-0 right-0 ring-1 ring-blue-200 dark:ring-[#334155] font-inter" id="collegeFilterContent">
                            <input type="text" class="search-input" placeholder="Search colleges...">
                            <div class="p-2 text-gray-500 dark:text-blue-200">No colleges loaded yet.</div>
                        </div>
                    </div>
                </div>
                <div class="md:col-span-2">
                    <button id="predictButton" class="w-full bg-gradient-to-r from-blue-600 via-indigo-500 to-purple-500 text-white py-2 sm:py-3 rounded-lg font-bold text-base sm:text-lg hover:from-blue-700 hover:to-purple-600 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 shadow-md hover:shadow-xl active:scale-95 font-inter">Predict Colleges</button>
                </div>
            </div>
            <div id="loadingIndicator" class="flex flex-col items-center justify-center my-4 text-blue-700 dark:text-blue-200 hidden font-inter">
                <svg class="animate-spin h-6 w-6 text-blue-600 dark:text-blue-200 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>
                <span>Fetching data, please wait...</span>
            </div>
            <div id="results" class="mt-8 p-4 sm:p-6 bg-gray-50/80 dark:bg-[#181f2a]/80 rounded-xl shadow-inner border border-gray-200 dark:border-[#334155] min-h-[150px] max-h-[350px] sm:max-h-[400px] overflow-y-auto custom-scrollbar transition-all duration-300 font-inter text-[1.08rem] leading-relaxed">
                <p class="text-gray-500 dark:text-blue-200 text-center text-sm sm:text-base">Your predicted colleges and courses will appear here.</p>
            </div>
        </div>
    </div>

    <script>
        let keamData = [];
        const predictedRankInput = document.getElementById('predictedRank');
        const studentCategorySelect = document.getElementById('studentCategory');
        const predictButton = document.getElementById('predictButton');
        const resultsDiv = document.getElementById('results');
        const loadingIndicator = document.getElementById('loadingIndicator');

        const branchDropdown = document.getElementById('branchDropdown');
        const branchDropdownButton = document.getElementById('branchDropdownButton');
        const branchDropdownContent = document.getElementById('branchDropdownContent');
        const branchSearchInput = branchDropdownContent.querySelector('.search-input');

        const collegeFilterDropdown = document.getElementById('collegeFilterDropdown');
        const collegeFilterButton = document.getElementById('collegeFilterButton');
        const collegeFilterContent = document.getElementById('collegeFilterContent');
        const collegeSearchInput = collegeFilterContent.querySelector('.search-input');

        const categoryOrder = ["SM", "EZ", "MU", "LA", "BH", "DV", "VK", "BX", "KN", "KU", "SC", "ST", "EW"];
        const categoryNames = {
            "SM": "SM (State Merit/General)",
            "EZ": "EZ (Ezhava)",
            "MU": "MU (Muslim)",
            "LA": "LA (Latin Catholic)",
            "BH": "BH (Other Backward Hindu)",
            "DV": "DV (Dheevara)",
            "VK": "VK (Viswakarma)",
            "BX": "BX (B.X.)",
            "KN": "KN (Kusavan)",
            "KU": "KU (Kudumi)",
            "SC": "SC (Scheduled Caste)",
            "ST": "ST (Scheduled Tribe)",
            "EW": "EW (EWS)"
        };

        async function fetchKeamData() {
            loadingIndicator.style.display = 'block';
            predictButton.disabled = true;
            studentCategorySelect.innerHTML = '<option value="">Loading Categories...</option>';
            branchDropdownContent.querySelector('div').textContent = 'Loading Branches...'; // Update text
            collegeFilterContent.querySelector('div').textContent = 'Loading Colleges...'; // Update text

            try {
                const githubUrl = 'https://raw.githubusercontent.com/zafarlovesprogramming/KEAM-Cutoff-2025-TO-APPLY---Table-1/refs/heads/main/KEAM%20Cutoff%202025%20TO%20APPLY%20-%20Table%201.tsv';
                const response = await fetch(githubUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const tsvText = await response.text();
                keamData = parseTSV(tsvText);
                populateCategories();
                populateBranches();
                populateCollegesFilter(keamData); // Populate initial college filter with all colleges
                predictButton.disabled = false;
            } catch (error) {
                console.error("Error fetching or parsing KEAM data:", error);
                resultsDiv.innerHTML = '<p class="text-red-600 text-center">Failed to load data. Please ensure the TSV file from GitHub is correctly formatted and accessible, and that its header is present.</p>';
                studentCategorySelect.innerHTML = '<option value="">Error loading categories</option>';
                branchDropdownContent.querySelector('div').textContent = 'Error loading branches';
                collegeFilterContent.querySelector('div').textContent = 'Error loading colleges';
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        function parseTSV(tsvText) {
            const lines = tsvText.split('\n');
            let headerLineIndex = -1;

            for (let i = 0; i < lines.length; i++) {
                if (lines[i].trim().startsWith('Name of College')) {
                    headerLineIndex = i;
                    break;
                }
            }

            if (headerLineIndex === -1) {
                console.error("Error: 'Name of College' header line not found in TSV.");
                throw new Error("'Name of College' header line not found in TSV.");
            }

            const headerLine = lines[headerLineIndex];
            const headers = headerLine.split('\t').map(h => h.trim()).filter(Boolean);

            const collegeNameColIndex = headers.indexOf('Name of College');
            const courseColIndex = headers.indexOf('Course');
            const specialCategoriesColIndex = headers.indexOf('Special Categories');

            const data = [];
            const tsvHeaderToCategoryCode = {};
            for (const code of categoryOrder) {
                const fullHeader = headers.find(h => h.includes(code));
                if (fullHeader) {
                    tsvHeaderToCategoryCode[fullHeader] = code;
                }
            }

            for (let i = headerLineIndex + 1; i < lines.length; i++) {
                const line = lines[i];
                const values = line.split('\t').map(v => v.trim());

                if (values.length < headers.length || line.trim() === '') {
                    continue;
                }

                if (collegeNameColIndex === -1 || courseColIndex === -1 ) {
                    console.error("Missing required headers in TSV: 'Name of College' or 'Course'.");
                    throw new Error("Missing required headers in TSV.");
                }

                const collegeName = values[collegeNameColIndex];
                const courseName = values[courseColIndex];

                if (!collegeName || !courseName) {
                    continue;
                }

                headers.forEach((header, index) => {
                    const categoryCode = tsvHeaderToCategoryCode[header];
                    if (categoryCode && values[index]) {
                        const rankValueRaw = values[index];
                        if (rankValueRaw !== '-' && !isNaN(parseInt(rankValueRaw, 10))) {
                            data.push({
                                "College": collegeName,
                                "Course": courseName,
                                "Category": categoryCode,
                                "Last Rank 2024": parseInt(rankValueRaw, 10)
                            });
                        }
                    }
                });

                if (specialCategoriesColIndex !== -1 && values[specialCategoriesColIndex]) {
                    const specialCategoriesValue = values[specialCategoriesColIndex];
                    if (specialCategoriesValue) {
                        const specialCategories = specialCategoriesValue.split(',').map(s => s.trim()).filter(Boolean);
                        specialCategories.forEach(sc => {
                            const parts = sc.split(':');
                            if (parts.length === 2 && !isNaN(parseInt(parts[1], 10))) {
                                data.push({
                                    "College": collegeName,
                                    "Course": courseName,
                                    "Category": parts[0].trim(),
                                    "Last Rank 2024": parseInt(parts[1], 10)
                                });
                            }
                        });
                    }
                }
            }
            return data;
        }

        function populateCategories() {
            studentCategorySelect.innerHTML = '<option value="">Select Category</option>';
            const uniqueCategories = [...new Set(keamData.map(item => item.Category))];

            uniqueCategories.sort((a, b) => {
                const indexA = categoryOrder.indexOf(a);
                const indexB = categoryOrder.indexOf(b);

                if (indexA === -1 && indexB === -1) {
                    return a.localeCompare(b);
                }
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
            
            uniqueCategories.forEach(categoryCode => {
                const option = document.createElement('option');
                option.value = categoryCode;
                option.textContent = categoryNames[categoryCode] || categoryCode; 
                studentCategorySelect.appendChild(option);
            });
        }

        function populateBranches() {
            // Clear existing content except the search input
            const existingSearchInput = branchDropdownContent.querySelector('.search-input');
            branchDropdownContent.innerHTML = '';
            branchDropdownContent.appendChild(existingSearchInput); // Re-add search input

            const uniqueBranches = [...new Set(keamData.map(item => item.Course))].sort();

            if (uniqueBranches.length === 0) {
                const noBranchesDiv = document.createElement('div');
                noBranchesDiv.className = 'p-2 text-gray-500';
                noBranchesDiv.textContent = 'No branches found.';
                branchDropdownContent.appendChild(noBranchesDiv);
                return;
            }

            uniqueBranches.forEach(branch => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'custom-dropdown-item branch-item'; // Add class for filtering
                itemDiv.innerHTML = `
                    <input type="checkbox" id="branch-${branch.replace(/\s/g, '_')}" value="${branch}">
                    <label for="branch-${branch.replace(/\s/g, '_')}">${branch}</label>
                `;
                branchDropdownContent.appendChild(itemDiv);
            });
        }

        function populateCollegesFilter(dataToFilter) {
            // Clear existing content except the search input
            const existingSearchInput = collegeFilterContent.querySelector('.search-input');
            collegeFilterContent.innerHTML = '';
            collegeFilterContent.appendChild(existingSearchInput); // Re-add search input

            const uniqueColleges = [...new Set(dataToFilter.map(item => item.College))].sort();

            if (uniqueColleges.length === 0) {
                const noCollegesDiv = document.createElement('div');
                noCollegesDiv.className = 'p-2 text-gray-500';
                noCollegesDiv.textContent = 'No colleges available for filtering.';
                collegeFilterContent.appendChild(noCollegesDiv);
                return;
            }

            uniqueColleges.forEach(college => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'custom-dropdown-item college-item'; // Add class for filtering
                itemDiv.innerHTML = `
                    <input type="checkbox" id="college-${college.replace(/\s/g, '_').replace(/[^\w-]/g, '')}" value="${college}">
                    <label for="college-${college.replace(/\s/g, '_').replace(/[^\w-]/g, '')}">${college}</label>
                `;
                collegeFilterContent.appendChild(itemDiv);
            });
        }

        // Search functionality for Branch Dropdown
        branchSearchInput.addEventListener('keyup', () => {
            const searchTerm = branchSearchInput.value.toLowerCase();
            branchDropdownContent.querySelectorAll('.branch-item').forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                if (label.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        });

        // Search functionality for College Filter Dropdown
        collegeSearchInput.addEventListener('keyup', () => {
            const searchTerm = collegeSearchInput.value.toLowerCase();
            collegeFilterContent.querySelectorAll('.college-item').forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                if (label.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        });

        // Dropdown open/close and search (delegated)
        [[branchDropdownButton, branchDropdownContent, branchSearchInput, 'branch'], [collegeFilterButton, collegeFilterContent, collegeSearchInput, 'college']].forEach(([btn, content, search, type]) => {
            btn.addEventListener('click', e => { content.classList.toggle('show'); if(content.classList.contains('show')) search.focus(); });
            search.addEventListener('keyup', () => filterDropdown(content, type, search.value.toLowerCase()));
        });
        window.addEventListener('click', e => {
            if (!document.getElementById('branchDropdown').contains(e.target)) branchDropdownContent.classList.remove('show');
            if (!document.getElementById('collegeFilterDropdown').contains(e.target)) collegeFilterContent.classList.remove('show');
        });
        // Update button text on page load (in case of pre-checked)
        updateDropdownButtonText('branch');
        updateDropdownButtonText('college');

        function populateDropdown(content, items, type) {
            const search = content.querySelector('.search-input');
            content.innerHTML = '';
            content.appendChild(search);
            if(!items.length){
                content.innerHTML += `<div class="p-2 text-gray-500">No ${type==='branch'?'branches':'colleges'} found.</div>`;
                return;
            }
            items.forEach(item=>{
                const id = `${type}-${item.replace(/\s/g,'_').replace(/[^\w-]/g,'')}`;
                content.innerHTML += `<div class="custom-dropdown-item ${type}-item"><input type="checkbox" id="${id}" value="${item}"><label for="${id}" class="ml-2">${item}</label></div>`;
            });
        }

        function updateDropdownButtonText(type) {
            let content, button, defaultText;
            if (type === 'branch') {
                content = branchDropdownContent;
                button = branchDropdownButton;
                defaultText = 'Select Branches (Leave unchecked for no specific preference)';
            } else {
                content = collegeFilterContent;
                button = collegeFilterButton;
                defaultText = 'Select Colleges (Leave unchecked for all colleges)';
            }
            const checked = Array.from(content.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            let text = defaultText;
            if (checked.length === 1) text = checked[0];
            else if (checked.length === 2) text = checked.join(', ');
            else if (checked.length > 2) text = `${checked.length} selected`;
            button.querySelector('span').textContent = text;
        }

        predictButton.addEventListener('click', () => {
            const predictedRank = parseInt(predictedRankInput.value);
            const selectedCategory = studentCategorySelect.value;

            const selectedBranchCheckboxes = Array.from(branchDropdownContent.querySelectorAll('input[type="checkbox"]:checked'));
            const selectedBranches = selectedBranchCheckboxes.map(checkbox => checkbox.value);

            const selectedCollegeCheckboxes = Array.from(collegeFilterContent.querySelectorAll('input[type="checkbox"]:checked'));
            const selectedColleges = selectedCollegeCheckboxes.map(checkbox => checkbox.value);


            if (isNaN(predictedRank) || predictedRank <= 0) {
                resultsDiv.innerHTML = '<p class="text-red-600 text-center">Please enter a valid predicted rank (a positive number).</p>';
                return;
            }
            if (!selectedCategory) {
                resultsDiv.innerHTML = '<p class="text-red-600 text-center">Please select a student category.</p>';
                return;
            }

            let relevantColleges = keamData.filter(college => {
                // Apply college filter first if any colleges are selected
                const isCollegeSelected = selectedColleges.length === 0 || selectedColleges.includes(college.College);
                return isCollegeSelected && (college.Category === selectedCategory) && predictedRank <= college['Last Rank 2024'];
            });

            if (selectedCategory !== "SM") {
                const smResults = keamData.filter(college => {
                    const isCollegeSelected = selectedColleges.length === 0 || selectedColleges.includes(college.College);
                    return isCollegeSelected && (college.Category === "SM") && predictedRank <= college['Last Rank 2024'];
                });
                relevantColleges = relevantColleges.concat(smResults);
            }

            if (selectedBranches.length > 0) {
                relevantColleges = relevantColleges.filter(college => selectedBranches.includes(college.Course));
            }

            const finalResultsMap = new Map();

            for (const collegeEntry of relevantColleges) {
                const key = `${collegeEntry.College}|${collegeEntry.Course}`;
                if (!finalResultsMap.has(key)) {
                    finalResultsMap.set(key, collegeEntry);
                } else {
                    const existingEntry = finalResultsMap.get(key);
                    if (collegeEntry.Category === "SM" && existingEntry.Category !== "SM") {
                        finalResultsMap.set(key, collegeEntry);
                    } else if (collegeEntry.Category === existingEntry.Category && collegeEntry['Last Rank 2024'] < existingEntry['Last Rank 2024']) {
                         finalResultsMap.set(key, collegeEntry);
                    }
                }
            }

            const finalColleges = Array.from(finalResultsMap.values());
            displayResults(finalColleges);
        });

        function displayResults(colleges) {
            if (!colleges.length) return resultsDiv.innerHTML = '<p class="text-gray-500 dark:text-blue-200 text-center">No colleges or courses found for your selected criteria.</p>';
            colleges.sort((a,b)=>a['Last Rank 2024']-b['Last Rank 2024']||a.College.localeCompare(b.College)||a.Course.localeCompare(b.Course));
            const grouped = colleges.reduce((acc,c)=>(acc[c.College]=acc[c.College]||[],acc[c.College].push(c),acc),{});
            resultsDiv.innerHTML = Object.entries(grouped).map(([college,arr])=>`
              <div class="mb-4 p-4 bg-white/90 dark:bg-[#232946] rounded-lg shadow-md border border-blue-100 dark:border-[#334155] transition hover:scale-105 hover:shadow-xl duration-200">
                <h3 class="text-lg font-bold text-blue-700 dark:text-blue-100 mb-2">${college}</h3>
                <ul class="space-y-2">
                  ${arr.map(course=>`
                    <li class="flex items-center justify-between gap-2 flex-wrap">
                      <div class="flex flex-col min-w-0">
                        <span class="font-semibold text-gray-800 dark:text-blue-100 text-base leading-tight truncate">${cleanCourseName(course.Course)}</span>
                        <span class="text-xs italic text-gray-500 dark:text-blue-200 leading-tight">Category: ${categoryNames[course.Category]||course.Category}</span>
                      </div>
                      <span class="flex-shrink-0 inline-flex items-center justify-center bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-200 font-bold rounded-full px-5 py-1.5 text-base shadow-sm border border-blue-200 dark:border-blue-800" style="min-width: 90px; text-align: center;">Cutoff:<br><span class='text-lg font-extrabold tracking-wide'>${course['Last Rank 2024']}</span></span>
                    </li>
                  `).join('')}
                </ul>
              </div>
            `).join('');
        }

        // Helper to remove abbreviation before colon in course name
        function cleanCourseName(name) {
            return name.includes(':') ? name.split(':').slice(1).join(':').trim() : name;
        }

        fetchKeamData();

        // Attach event listeners ONCE after dropdowns are first populated
        branchDropdownContent.addEventListener('change', function(e) {
            if (e.target && e.target.type === 'checkbox') {
                updateDropdownButtonText('branch');
            }
        });
        collegeFilterContent.addEventListener('change', function(e) {
            if (e.target && e.target.type === 'checkbox') {
                updateDropdownButtonText('college');
            }
        });

        // Minimal dark/light mode toggle logic with dual icon crossfade
        const themeToggle = document.getElementById('themeToggle');
        function setTheme(mode) {
            if (mode === 'dark') {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
        }
        (function() {
            let mode = localStorage.getItem('theme');
            if (!mode) {
                mode = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            setTheme(mode);
        })();
        themeToggle.addEventListener('click', function() {
            const isDark = document.documentElement.classList.contains('dark');
            setTheme(isDark ? 'light' : 'dark');
        });

        // Fetch user location and display in #userLocation
        fetch('https://ipapi.co/json/')
          .then(res => res.json())
          .then(data => {
            const loc = document.getElementById('userLocation');
            if (data && (data.city || data.country_name)) {
              loc.textContent = `Your location: ${data.city ? data.city + ', ' : ''}${data.country_name}`;
            }
          })
          .catch(() => {});
    </script>
    <!-- Disclaimer and location info fixed footer -->
    <div class="fixed bottom-3 left-1/2 -translate-x-1/2 z-50 w-full max-w-xl px-2 flex flex-col items-center pointer-events-none">
      <div id="userLocation" class="mb-1 text-xs text-gray-500 dark:text-blue-200/80 pointer-events-auto"></div>
      <div class="bg-gray-100/90 dark:bg-[#232946]/90 rounded-lg p-3 text-xs text-gray-600 dark:text-blue-200/80 shadow-sm border border-gray-200 dark:border-[#334155] pointer-events-auto backdrop-blur-md">
        <strong>Disclaimer:</strong> This site uses last year's KEAM cutoffs for predictions. Actual cutoffs may vary. Use this tool for guidance only, not as a guarantee of admission.
      </div>
    </div>
</body>
</html>
